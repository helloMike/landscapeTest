<html>
<head>
    <title>市场数据监控</title>
    <meta charset="utf-8"/>
    <meta name="decorator" content="default" />
    <script src="./jquery-1.8.3.min.js"></script>
    <script src="./echarts.min.js"></script>
    <link rel="stylesheet" href="./numberAnimate.css">
    <link rel="stylesheet" href="./marketdatamonitor.css">
</head>
<body>
<div class="wrapper"></div>
<div class="page-container">
    <div class="top-title">
        市场数据监控
        <div class="date-time">
            <span id="weekDay">星期四</span>
            <span style="color:#6FA2F7;">/</span>
            <span id="date">2019-01-10</span>
            <span style="color:#6FA2F7;">/</span>
            <span id="hhmmss">13:40:00</span>
        </div>
    </div>
    <div class="content">
        <div class="left">
            <div class="manager-top-5">
                <div class="content-title"></div>
                <div class="manager-content">
                    <div id="manager-chart" style="height:300px;"></div>
                </div>
            </div>
            <div class="price-analyze">
                <div class="price-analyze-container">
                    <div class="content-title"></div>
                    <div class="price-analyze-content">
                        <div class="list price">
                            <div class="list-head">
                                <div class="list-item">
                                    <div class="item">商品名称</div>
                                    <div class="item">平均单价(元)</div>
                                    <div class="item">交易日期</div>
                                </div>
                            </div>
                            <div class="list-body" id="price-analyze">
                                <div class="hide-scroll-bar"></div>
                                <div id="price-analyze-list" class="list-item-container">
                                    <div class="list-item">
                                        <div class="item"></div>
                                        <div class="item"></div>
                                        <div class="item"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="middle">
            <div class="money-number">
                <div class="money">
                    <div class="money-container">
                        <div class="left-part">
                            <i class="icon-part icon-money"></i>
                        </div>
                        <div class="right-part">
                            <p class="right-part-title">金额(元)</p>
                            <p id="money-value">暂无数据</p>
                        </div>
                    </div>
                </div>
                <div class="number">
                    <div class="number-container">
                        <div class="left-part">
                            <i class="icon-part icon-number"></i>
                        </div>
                        <div class="right-part">
                            <p class="right-part-title">数量(条)</p>
                            <p id="number-value">暂无数据</p>
                        </div>
                    </div>
                </div>
                <i class="corner topL"></i>
                <i class="corner topR"></i>
                <i class="corner bottomL"></i>
                <i class="corner bottomR"></i>
            </div>
            <div class="real-time-trade">
                <div class="content-title">
                    实时交易
                </div>
                <div class="real-time-trade-content">
                    <div class="list real-time">
                        <div class="list-head">
                            <div class="list-item">
                                <div class="item">归属商户</div>
                                <div class="item">销售品名</div>
                                <div class="item">数量(kg)</div>
                                <div class="item">单价(元)</div>
                                <div class="item">交易日期</div>
                            </div>
                        </div>
                        <div class="list-body" id="real-time">
                            <div class="hide-scroll-bar"></div>
                            <div id="real-time-list" class="list-item-container">
                                <div class="list-item">
                                    <div class="item"></div>
                                    <div class="item"></div>
                                    <div class="item"></div>
                                    <div class="item"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="right">
            <div class="product-top-5">
                <div class="content-title"></div>
                <div class="product-content">
                    <table class="product-table" style="height:250px;margin:0 auto;">
                        <thead>
                        <tr>
                            <td>商品名称</td>
                            <td>排行</td>
                            <td>TOP图</td>
                        </tr>
                        </thead>
                        <tbody id="product-data">
                        <tr>
                            <td></td>
                            <td></td>
                            <td rowspan="5">
                                <div id="product-chart" style="height:250px;"></div>
                            </td>
                        </tr>
                        <tr>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td></td>
                            <td></td>
                        </tr>

                        </tbody>
                        <tbody id="product-no-data">
                            <tr><td colspan="3" style="text-align:center;color:#6FA2F7;">暂无数据</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="detect-analyze">
                <div class="detect-analyze-container">
                    <div class="content-title"></div>
                    <div class="detect-analyze-content">
                        <div class="list detect">
                            <div class="list-head">
                                <div class="list-item">
                                    <div class="item">商户名称</div>
                                    <div class="item">商品名称</div>
                                    <div class="item">检测内容</div>
                                    <div class="item">检测结果</div>
                                </div>
                            </div>
                            <div class="list-body" id="detect-analyze">
                                <div class="hide-scroll-bar"></div>
                                <div id="detect-analyze-list" class="list-item-container">
                                    <div class="list-item">
                                        <div class="item"></div>
                                        <div class="item"></div>
                                        <div class="item"></div>
                                        <div class="item"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script type="text/javascript" src="jquery-1.8.3.min.js"></script>
<!--<script type="text/javascript" src="./particle-bg.umd.min.js"></script>-->
<script type="text/javascript" src="numberAnimate.js"></script>
<script>
    $(function(){
        let sum_num = false,
            sum_money = false;
        const setHeightOfRemain = function(elements){
            let docEl= document.documentElement;
            let clientHeight = docEl.clientHeight;
            if(!clientHeight){
                return ;
            }
            for(let i = 0; i<elements.length;i++){
                let elementHeight = ''
                let $element = document.querySelector(elements[i].target)
                if(elements[i].tag ==='left' || elements[i].tag ==='right'){
                    //去除掉顶部各个容器的高度以及间距
                    elementHeight = clientHeight - (350 + 50 + 100 + 20 + 100)
                    $element.style.height = elementHeight
                }else{
                    elementHeight = clientHeight - (100 + 150 + 100 + 30 + 100)
                    $element.style.height = elementHeight
                }
            }

        }

        const getTime = function(){
            var now = new Date()
            var weekDay = "星期"
            var year = now.getFullYear()
            var month = now.getMonth()+1<10?'0'+(now.getMonth()+1):(now.getMonth()+1)
            var day = now.getDate()<10?'0'+now.getDate():now.getDate()
            var date_str = year+'-'+month+'-'+day
            var hh = now.getHours()<10?'0'+now.getHours():now.getHours()
            var mm= now.getMinutes()<10?'0'+now.getMinutes():now.getMinutes()
            var ss = now.getSeconds()<10?'0'+now.getSeconds():now.getSeconds()
            var hhmmss = hh+':'+mm+':'+ss
            switch(now.getDay()){
                case 1:
                    weekDay+="一";
                    break;
                case 2:
                    weekDay+="二";
                    break;
                case 3:
                    weekDay+="三";
                    break;
                case 4:
                    weekDay+="四";
                    break;
                case 5:
                    weekDay+="五";
                    break;
                case 6:
                    weekDay+="六";
                    break;
                default:
                    weekDay+="日"
            }
            return{
                /*date_str,weekDay,hhmmss*/
                date_str:date_str,
                weekDay:weekDay,
                hhmmss:hhmmss
            }
        }

        const showDateTime = function(){
            let now = getTime()
            let $weekDay = $("#weekDay")
            let $date = $("#date")
            let $hhmmss = $("#hhmmss")
            $weekDay.html(now.weekDay)
            $date.html(now.date_str)
            $hhmmss.html(now.hhmmss)
            let timer = setInterval(function(){
                now = getTime()
                $weekDay.html(now.weekDay)
                $date.html(now.date_str)
                $hhmmss.html(now.hhmmss)
            },1000)
        }

        const setEchartsWidth = function(ids,percentOfClientWidth){
            let docEl = document.documentElement,
                clientWidth = docEl.clientWidth;
            for(let i=0;i<ids.length;i++){
                let id = ids[i];
                let $element = document.querySelector('#'+id);
                //去除边距
                $element.style.width = clientWidth * percentOfClientWidth - 20 - 20;
                if(id == 'product-chart'){
                    $element.style.width = clientWidth * percentOfClientWidth * 0.6;
                }
            }
        }

        const scrollList = function(obj){
            let targets = obj.split(",");
            for(let i=0;i<targets.length;i++){
                let $this= $(targets[i]),
                    height = $this.find(".list-item").last().height(),
                    scrollTimer = "";
                $this.hover(function(){
                    $this.find(".list-item").first().stop(true,true)
                    $this.find(".list-item").first().height()
                    clearInterval(scrollTimer)
                },function(){
                    /*   if($this.height()==$this[0].scrollHeight){
                           return ;
                      }  */
                    let $temp = "";
                    //用户滚动查看完后回滚会顶部
                    $this.animate({scrollTop:0},1600)
                    scrollTimer = setInterval(function(){
                        $temp = $this.find(".list-item").last();
                        $this.find(".list-item").last().remove();
                        $temp.css({
                            'height':0
                        })
                        $this.prepend($temp);
                        $temp.animate({'height':height},800,function(){
                        })
                    },2400);
                });
                $this.trigger("mouseleave");
            }
        }

        const GetData = function(){}
            GetData.prototype.getTop5 = function(chartTarget){
                $.ajax({url:'./product_top_5.json',success:function(res){
                        if(res.code == 0){
                            let data = res.data[0].topTenByAllMarket,
                            product_data = {
                                title:[],
                                data:[]
                            },
                             xMax= 0,
                             max = 0,
                             colors = [
                                 {
                                     color_0:'rgba(11,42,84,.3)',
                                     color_100:'#3C77D8'
                                 },
                                 {
                                     color_0:'rgba(11,42,84,.3)',
                                     color_100:'#b250ff'
                                 },
                                 {
                                     color_0:'rgba(11,42,84,.3)',
                                     color_100:'#4f9aff'
                                 },
                                 {
                                     color_0:'rgba(11,42,84,.3)',
                                     color_100:'#4bf3ff'
                                 },
                                 {
                                     color_0:'rgba(11,42,84,.3)',
                                     color_100:'#4bf3ff'
                                 },
                             ],
                             table_data =[];
                            data.reduce(function(acc,cur){
                                acc.data.push(cur.saleNum)
                                acc.title.push(cur.productName)
                                return acc
                            },product_data)
                            product_data.data = product_data.data.slice(0,5).reverse()
                            product_data.title = product_data.title.slice(0,5).reverse()
                            //dom-part
                            product_data.title.forEach(function(item){
                                let obj = {};
                                obj = item;
                                table_data.push(obj);
                            })
                            table_data = table_data.reverse()
                            let domTarget = document.querySelectorAll('.product-table tbody tr')
                            table_data.forEach(function(item,index){
                                let $td = domTarget[index].querySelectorAll('td');
                                $td[0].innerText = item;
                                $td[1].innerText = (index + 1);
                            })
                            //chart-part
                       /*     max = Math.max(...product_data.data);*/
                            max = product_data.data[0]
                            for(let i=0,j=product_data.data.length;i<j;i++){
                                if(product_data.data[i] - max > 0){
                                    max = product_data.data[i]
                                }
                            }
                            xMax = Math.ceil(max/10)*10;
                            console.log(product_data.data,max,xMax)
                            let product_option = {
                                baseOption:{
                                    grid:{
                                        top:0,
                                        left:0,
                                        width:'100%',
                                        height:'100%'
                                    },
                                    tooltip: {
                                        show: true,
                                        formatter: ""
                                    },
                                    xAxis: [{
                                        axisTick: {
                                            show: false,
                                        },
                                        axisLine: {
                                            show: false,
                                        },
                                        axisLabel: {
                                            show: false
                                        },
                                        splitLine: {
                                            show: false,
                                        }
                                    }],
                                    yAxis: [{
                                        type: 'category',
                                        data: product_data.title,
                                        axisTick: {
                                            show: false,
                                        },
                                        axisLine: {
                                            show: false,
                                        },
                                        axisLabel: {
                                            show:false
                                        }
                                    }],
                                    series: [{
                                        name: ' ',
                                        type: 'bar',
                                        barWidth: 16,
                                        silent: true,
                                        itemStyle: {
                                            normal: {
                                                color: 'rgba(0,0,0,0.5)',
                                                barBorderRadius: [0, 10, 10, 0],
                                                borderWidth:'2',
                                                borderColor:'#8FB6F6'
                                            }

                                        },
                                        barGap: '-100%',
                                        barCategoryGap: '200%',
                                        data: data.map(function(d) {
                                            return xMax
                                        }),
                                    }, {
                                        name: ' ',
                                        type: 'bar',
                                        barWidth: 16,
                                        label: {
                                            normal: {
                                                show: true,
                                                position: 'inside',
                                                formatter: '{c}',
                                            }
                                        },
                                        data:product_data.data.map(function(item,index){
                                            return {
                                                value: item,
                                                itemStyle: {
                                                    normal: {
                                                        barBorderRadius: [0, 10, 10, 0],
                                                        color: {
                                                            type: 'bar',
                                                            colorStops: [{
                                                                offset: 0,
                                                                color: colors[index].color_0 // 0% 处的颜色
                                                            }, {
                                                                offset: 1,
                                                                color: colors[index].color_100 // 100% 处的颜色
                                                            }],
                                                            globalCoord: false, // 缺省为 false
                                                        }
                                                    }
                                                }
                                            }
                                        })
                                    }]
                                },
                                media:[{
                                    query:{
                                        maxWidth:350,
                                        maxHeight:185
                                    },
                                    option:{}
                                }],

                            };
                            chartTarget.setOption(product_option);
                        }else{
                            alert(res.msg);
                        }
                    }})
                return this
            }
            GetData.prototype.getTotalNum = function(){
                $.ajax({url:'./total_num.json',success:function(res){
                        if(res.code == 0){
                            let data = res.data;
                            let total_num = 0;
                            total_num = data.reduce(function(acc,cur){
                                return acc + parseInt(cur.value);
                            },total_num);
                            if(total_num !=sum_num){
                                $("#number-value").numberAnimate({num:total_num, speed:2000, symbol:","});
                                sum_num = total_num;
                            }

                        }else{
                            alert(res.msg);
                        }
                    }})
                return this
            }
            GetData.prototype.getTotalMoney = function(){
                $.ajax({url:'./total_money.json',success:function(res){
                        if(res.code == 0){
                            let data = res.data;
                            let total_money = 0;
                            total_money = Math.ceil(data.reduce(function(acc,cur){
                                return acc + Number(cur.value)
                            },total_money))
                            if(total_money !=sum_money){
                                $("#money-value").numberAnimate({num:total_money, speed:2000, symbol:","});
                                sum_money = total_money;
                            }
                        }else{
                            alert(res.msg)
                        }
                    }})
                return this
            }
            GetData.prototype.getPriceAnalyze = function(){
                $.ajax({url:'./price_analyze.json',success:function(res){
                        if(res.code == 0){
                            let data = res.data;
                            let list_item = '';
                            data.forEach(function(item,index){
                                list_item += '<div class="list-item">' +
                                                '<div class="item">'+(item.productName || "————")+'</div>' +
                                                '<div class="item">'+(item.avgUnitPrice  || "————") +'</div>' +
                                                '<div class="item">'+(item.transDate.split(" ")[0] || "————")+'</div>' +
                                            '</div>'
                            })
                            document.querySelector("#price-analyze-list").innerHTML = list_item
                        }else{
                            alert(res.msg)
                        }
                    }})
                return this
            }
            GetData.prototype.getDetectAnalyze = function(){
                $.ajax({url:'./detect_analyze.json',success:function(res){
                        if(res.code == 0){
                            let data = res.data;
                            let list_item = '';
                            data.forEach(function(item,index){
                                list_item += '<div class="list-item">' +
                                    '<div class="item">'+(item.merchant.name || "————")+'</div>' +
                                    '<div class="item">'+(item.product.name || "————")+'</div>' +
                                    '<div class="item">'+(item.checkContent || "————")+'</div>' +
                                    '<div class="item">'+(item.checkResult == 1 ? "合格":"不合格")+'</div>' +
                                    '</div>'
                            })
                            document.querySelector("#detect-analyze-list").innerHTML = list_item
                        }else{
                            alert(res.msg)
                        }
                    }})
                return this
            }
            GetData.prototype.getTradeData = function(){
                $.ajax({url:'./trade_data.json',success:function(res){
                        if(res.code == 0){
                            let data = res.data
                            let list_item = ""
                            data.forEach(function(item,index){
                                list_item += '<div class="list-item">' +
                                        '<div class="item">'+(item.merchant.name || "————")+'</div>' +
                                        '<div class="item">'+(item.productName || "————")+'</div>' +
                                        '<div class="item">'+(item.saleNum || "————")+'</div>' +
                                        '<div class="item">'+(item.unitPrice || "————")+'</div>' +
                                        '<div class="item">'+(item.createDate.split(" ")[0] || "————")+'</div>' +
                                    '</div>'
                            })
                            document.querySelector("#real-time-list").innerHTML = list_item
                        }else{
                            alert(res.msg)
                        }
                    }})
                return this
            }
            GetData.prototype.getManagerTop5 = function(chartTarget){
                $.ajax({url:'./manager_top_5.json',success:function(res){
                        if(res.code == 0){
                            console.log(res)
                            let data = res.data[0].topTenByAllMarket,
                                manager_data = {
                                    title:[],
                                    data:[]
                                },
                                colors = ["#ad46f3","#ad46f3","#5045f6","#4777f5","#44aff0"];
                                manager_data = data.reduce(function(acc,cur){
                                    acc.title.push(cur.merchantName)
                                    acc.data.push(cur.saleNum)
                                    return acc
                                },manager_data)

                             let manager_option = {
                                gird:{
                                    width:'100%',
                                    height:'80%'
                                },
                                "tooltip": {
                                    "trigger": "item",
                                    "formatter": "{a}<br/>{b}:{c}"
                                },
                                "title": {
                                    "text": "经营户排名TOP5",
                                    "left": "center",
                                    "top": 0,
                                    "textStyle": {
                                        "color": "#FFF",
                                        "fontWeight":'normal'
                                    }
                                },
                                "calculable": true,
                                "legend": {
                                    "icon": "circle",
                                    "x": "center",
                                    "y": "15%",
                                    "data": manager_data.title,
                                    "textStyle": {
                                        "color": "#fff"
                                    }
                                },
                                "series": [{
                                    "name": "",
                                    "type": "pie",
                                    "radius": [
                                        37,
                                        155
                                    ],
                                    "avoidLabelOverlap": false,
                                    "startAngle": 0,
                                    "center": [
                                        "50.1%",
                                        "34%"
                                    ],
                                    "roseType": "area",
                                    "selectedMode": "single",
                                    "label": {
                                        "normal": {
                                            "show": true,
                                            "formatter": "{c}"
                                        },
                                        "emphasis": {
                                            "show": true
                                        }
                                    },
                                    "labelLine": {
                                        "normal": {
                                            "show": true,
                                            "smooth": false,
                                            "length": 20,
                                            "length2": 10
                                        },
                                        "emphasis": {
                                            "show": true
                                        }
                                    },
                                        "data":manager_data.data.map(function(item,index){
                                            if(index>4){
                                                return {
                                                    "value": 0,
                                                    "name": "",
                                                    "itemStyle": {
                                                        "normal": {
                                                            "label": {
                                                                "show": false
                                                            },
                                                            "labelLine": {
                                                                "show": false
                                                            }
                                                        }
                                                    }
                                                }
                                            }else{
                                                return {
                                                    "value": item,
                                                    "name": manager_data.title[index],
                                                    "itemStyle": {
                                                        "normal": {
                                                            "color": colors[index]
                                                        }
                                                    }
                                                }
                                            }
                                        })
                                }]
                            };
                            chartTarget.setOption(manager_option);
                        }else{
                            alert(res.msg)
                        }
                    }})
                return this
            }

        const pageInit = function(){
            //设定底部各个容器的高度来适应屏幕
            setHeightOfRemain([
                {target:"#detect-analyze",tag:"right"},
                {target:"#price-analyze",tag:"left"},
                {target:"#real-time",tag:"middle"}])

            //根据屏幕宽度来设定图表的宽度
            setEchartsWidth(["product-chart","manager-chart"],0.32);

            //显示时间
            showDateTime()

            //初始化图表部分
            let productChart = echarts.init(document.getElementById('product-chart'));
            let managerChart = echarts.init(document.getElementById('manager-chart'));

            //获取各个数据
            let getData = new GetData();
            getData.getTop5(productChart)
                    .getManagerTop5(managerChart)
                    .getTotalMoney()
                    .getTotalNum()
                    .getPriceAnalyze()
                    .getDetectAnalyze()
                    .getTradeData()

            //定时请求
            setInterval(function(){
                getData.getTotalMoney()
                        .getTotalNum()
                    .getTradeData()
            },10000)

            scrollList("#price-analyze-list,#detect-analyze-list,#real-time-list");
            window.onresize = function(){
                        setHeightOfRemain([
                            {target:"#detect-analyze",tag:"right"},
                            {target:"#price-analyze",tag:"left"},
                            {target:"#real-time",tag:"middle"}])
                        setEchartsWidth(["product-chart","manager-chart"],0.32)
                        productChart.resize()
                        managerChart.resize()
                    }
        }

        pageInit();


    })
</script>
</html>
